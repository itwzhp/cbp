name: Build and deploy

on:
  push:
    branches: [production, main, add-copy]
  pull_request:
    branches: [main]

env:
  ENVIRONMENT_NAME: "${{ github.event_name == 'push' && github.ref_name == 'production' && 'prod' || 'dev' }}"

jobs:
  build:
    name: Build and test
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE:  cbp_test
        ports:
          - 33306:3306  # external:internal
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:

###### Prepare environment
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '18.x'

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install PHP versions
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

########### Restore caches
      - name: Cache node_modules directory
        uses: actions/cache@v2
        id: node_modules-cache
        with:
          path: node_modules
          key: ${{ runner.OS }}-build-${{ hashFiles('**/package.json') }}-${{ hashFiles('**/package-lock.json') }}

      - name: Get Composer Cache Directory
        id: composer-cache
        run: |
          echo "::set-output name=dir::$(composer config cache-files-dir)"

      - name: Cache PHP composer cache
        uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Cache PHP dependencies
        uses: actions/cache@v2
        id: vendor-cache
        with:
          path: vendor
          key: ${{ runner.OS }}-build-${{ hashFiles('**/composer.lock') }}

###### Validate bicep
      - name: Validate Bicep
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: zhp-cbp-${{ env.ENVIRONMENT_NAME }}
          template: ./infrastructure/cbp.bicep
          deploymentMode: Validate
          parameters: environment=${{ env.ENVIRONMENT_NAME }}

###### Install dependencies
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      - name: Install Composer Dependencies
        if: steps.vendor-cache.outputs.cache-hit != 'true'
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Install NPM Dependencies
        if: steps.node_modules-cache.outputs.cache-hit != 'true'
        run: npm ci

###### Build
      - name: Build frontend
        run: npm run build

      - name: Generate key
        run: php artisan key:generate

##### Tests

      # - name: Run Migrations
      #   env:
      #     DB_CONNECTION: mysql
      #     DB_DATABASE: cbp_test
      #     DB_PORT: 33306
      #     DB_USER: root
      #   run: |
      #     chmod -R 777 storage bootstrap/cache
      #     php artisan migrate
      #     php artisan db:seed

      # - name: Check code style
      #   run: vendor/bin/pint --config vendor/apsg/coding-standards/pint.json --test
      # - name: Execute tests (Unit and Feature tests) via PestPHP
      #   env:
      #     DB_CONNECTION: mysql
      #     DB_DATABASE: cbp_test
      #     DB_PORT: 33306
      #     DB_USER: root
      #   run: vendor/bin/pest --parallel

##### Prepare & Publish artifact

      - name: Optimize
        run: php artisan optimize

      - name: Compress package
        run: tar --exclude="./tests"  --exclude="./node_modules" --exclude="./vendor/phpunit" --exclude=".git" --exclude=".github" --exclude="cbp-app-package.tar.gz" -cvf cbp-app-package.tar.gz . 

      - name: Publish artifact
        uses: actions/upload-artifact@v3
        with:
          name: cbp-app-package.tar.gz
          path: cbp-app-package.tar.gz

  deploy:
    name: Deploy
    if: github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    env:
      DEPLOY_USER: build
      DEPLOY_HOST: host.zhp.pl
      DEPLOY_PATH: /var/www/vhosts/zhp.pl/cbp-dev.zhp.pl
      PACKAGE_NAME: cbp-app-package
    steps:
      - name: Configure SSH
        run: ${{ secrets.ZHP_PL_SSH_CONFIG }}

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: cbp-app-package.tar.gz

      - name: Create directory for package
        run: mkdir ./$PACKAGE_NAME
      
      - name: Extract package
        run: tar -xvf $PACKAGE_NAME.tar.gz -C ./$PACKAGE_NAME

      # - name: Copy new version into server
      #   run: rsync -avzh ./$PACKAGE_NAME $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH

      - name: Copy new version into server
        run: scp -r ./$PACKAGE_NAME $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH

      - run: |
          echo 'TODO: odtworzyÄ‡ .env' - php artisan env:decrypt --env=production --key=${{ secrets.DECRYPT_KEY }} --force --filename=.env

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: zhp-cbp-${{ env.ENVIRONMENT_NAME }}
          template: ./infrastructure/cbp.bicep
          parameters: environment=${{ env.ENVIRONMENT_NAME }}

 